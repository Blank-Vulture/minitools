name: DocKeeper CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'dock-keeper/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'dock-keeper/**'
      - '.github/workflows/**'

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: GitHub Tokenã®æ¨©é™ã‚’æœ€å°é™ã«åˆ¶é™
permissions:
  contents: read
  security-events: write
  actions: read
  checks: write

env:
  SCRIPT_DIR: dock-keeper

jobs:
  # ========================================
  # é™çš„è§£æ & ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆæ—©æœŸç™ºè¦‹ï¼‰
  # ========================================
  security-scan:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Git historyã‚‚å«ã‚ã¦å–å¾—ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æç”¨ï¼‰

    - name: Run ShellCheck (SAST)
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: './dock-keeper'
        severity: error
        ignore_paths: |
          .git

    - name: Run Bandit Security Linter
      run: |
        pip install bandit
        # Bashã‚¹ã‚¯ãƒªãƒ—ãƒˆç”¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        find ${{ env.SCRIPT_DIR }} -name "*.sh" -exec grep -l "eval\|exec\|system" {} \; > security_concerns.txt || true
        if [ -s security_concerns.txt ]; then
          echo "âš ï¸ Security concerns found in:"
          cat security_concerns.txt
          echo "::warning::Potential security risks detected - please review"
        fi

    - name: Check for hardcoded secrets
      run: |
        # APIã‚­ãƒ¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œå‡º
        grep -r -i -E "(api[_-]?key|password|token|secret)" ${{ env.SCRIPT_DIR }}/ --include="*.sh" || true
        if [ $? -eq 0 ]; then
          echo "::warning::Potential hardcoded secrets detected"
        fi

  # ========================================
  # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ & æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
  # ========================================
  test-suite:
    name: ğŸ§ª Test Suite
    runs-on: macos-latest
    needs: security-scan
    
    strategy:
      matrix:
        test-type: [unit, security, performance]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Homebrew
      run: |
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || true
        brew --version

    - name: Install dependencies
      run: |
        cd ${{ env.SCRIPT_DIR }}
        chmod +x *.sh
        # ãƒ†ã‚¹ãƒˆã«æœ€ä½é™å¿…è¦ãªä¾å­˜é–¢ä¿‚ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        brew install dockutil || echo "dockutil installation skipped for CI"

    - name: Run Unit Tests
      if: matrix.test-type == 'unit'
      run: |
        cd ${{ env.SCRIPT_DIR }}
        ./test_dockeeper.sh
      env:
        CI: true

    - name: Run Security Tests
      if: matrix.test-type == 'security'
      run: |
        cd ${{ env.SCRIPT_DIR }}
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚’åˆ†é›¢å®Ÿè¡Œ
        ./test_dockeeper.sh | grep -A 20 "Testing security input validation"

    - name: Run Performance Benchmarks
      if: matrix.test-type == 'performance'
      run: |
        cd ${{ env.SCRIPT_DIR }}
        ./benchmark_dockeeper.sh
      continue-on-error: true  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã—ã¦ã‚‚CIã‚’æ­¢ã‚ãªã„

    - name: Upload benchmark results
      if: matrix.test-type == 'performance'
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: ${{ env.SCRIPT_DIR }}/benchmark_results_*.json
        retention-days: 30

  # ========================================
  # ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰
  # ========================================
  integration-test:
    name: ğŸ”— Integration Test
    runs-on: macos-latest
    needs: [security-scan, test-suite]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup test environment
      run: |
        cd ${{ env.SCRIPT_DIR }}
        chmod +x *.sh
        brew install dockutil || true

    - name: Test dry-run mode
      run: |
        cd ${{ env.SCRIPT_DIR }}
        ./dockeeper.sh --dry-run --verbose

    - name: Test help and version commands
      run: |
        cd ${{ env.SCRIPT_DIR }}
        ./dockeeper.sh --help
        ./dockeeper.sh --version

    - name: Validate script structure
      run: |
        cd ${{ env.SCRIPT_DIR }}
        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®åŸºæœ¬æ§‹é€ ã‚’ãƒ†ã‚¹ãƒˆ
        bash -n dockeeper.sh  # æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        if ! grep -q "main.*\$@" dockeeper.sh; then
          echo "::error::Main function call not found"
          exit 1
        fi

  # ========================================
  # ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ & å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
  # ========================================
  quality-gate:
    name: ğŸ“Š Quality Gate
    runs-on: ubuntu-latest
    needs: [test-suite, integration-test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check code complexity
      run: |
        cd ${{ env.SCRIPT_DIR }}
        # Bashã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¤‡é›‘åº¦ãƒã‚§ãƒƒã‚¯
        for file in *.sh; do
          lines=$(wc -l < "$file")
          functions=$(grep -c "^[[:space:]]*function\|^[[:space:]]*[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]*(" "$file")
          echo "File: $file - Lines: $lines, Functions: $functions"
          
          # å“è³ªã‚²ãƒ¼ãƒˆ: 500è¡Œä»¥ä¸Šã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯è­¦å‘Š
          if [ "$lines" -gt 500 ]; then
            echo "::warning::$file has $lines lines (>500 - consider refactoring)"
          fi
        done

    - name: Documentation check
      run: |
        # READMEã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        if [ ! -f README.md ]; then
          echo "::error::README.md not found"
          exit 1
        fi
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        cd ${{ env.SCRIPT_DIR }}
        version_in_script=$(grep "readonly VERSION=" dockeeper.sh | cut -d'"' -f2)
        
        # README.md ã®ãƒ‘ã‚¹ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—ã®ãƒ‡ãƒãƒƒã‚°
        if [ -f "../README.md" ]; then
          readme_first_line=$(head -n1 ../README.md)
          echo "README first line: $readme_first_line"
          version_in_readme=$(echo "$readme_first_line" | grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' | sed 's/v//' || echo "")
        else
          echo "::error::README.md not found at ../README.md"
          exit 1
        fi
        
        echo "Script version: $version_in_script"
        echo "README version: $version_in_readme"
        
        if [ "$version_in_script" != "$version_in_readme" ]; then
          echo "::error::Version mismatch - Script: $version_in_script, README: $version_in_readme"
          exit 1
        fi

  # ========================================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æœ€çµ‚ãƒã‚§ãƒƒã‚¯ & ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™
  # ========================================
  security-final-check:
    name: ğŸ›¡ï¸ Final Security Check
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Advanced security scan
      run: |
        cd ${{ env.SCRIPT_DIR }}
        echo "=== Advanced Security Scan ==="
        
        # å±é™ºãªBashã‚³ãƒãƒ³ãƒ‰ã®æ¤œå‡º
        dangerous_patterns=(
          "eval.*\$"
          "exec.*\$"
          "rm.*-rf.*/"
          "sudo"
          "curl.*|.*sh"
          "wget.*|.*sh"
        )
        
        for pattern in "${dangerous_patterns[@]}"; do
          if grep -n -E "$pattern" *.sh; then
            echo "::warning::Potentially dangerous pattern found: $pattern"
          fi
        done
        
        echo "=== Privilege Escalation Check ==="
        if grep -n "sudo\|su " *.sh; then
          echo "::error::Privilege escalation detected"
          exit 1
        fi

    - name: Generate security report
      run: |
        cd ${{ env.SCRIPT_DIR }}
        echo "# Security Scan Report" > security_report.md
        echo "Generated: $(date)" >> security_report.md
        echo "" >> security_report.md
        echo "## Files scanned:" >> security_report.md
        ls -la *.sh >> security_report.md
        echo "" >> security_report.md
        echo "## ShellCheck results:" >> security_report.md
        shellcheck *.sh >> security_report.md 2>&1 || echo "ShellCheck completed with warnings" >> security_report.md

    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: ${{ env.SCRIPT_DIR }}/security_report.md
        retention-days: 90

  # ========================================
  # é€šçŸ¥ & ãƒ¬ãƒãƒ¼ãƒˆ
  # ========================================
  notify:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [security-scan, test-suite, integration-test, quality-gate, security-final-check]
    if: always()
    
    steps:
    - name: Build status summary
      run: |
        echo "# DocKeeper CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.security-final-check.result }}" = "success" ]; then
          echo "âœ… **Security:** All checks passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Security:** Issues detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "ğŸ“Š **Artifacts:** Check the Actions tab for detailed reports" >> $GITHUB_STEP_SUMMARY

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const summary = `## DocKeeper CI/CD Results ğŸ¤–
          
          **Security Scan:** ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          **Tests:** ${{ needs.test-suite.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          **Integration:** ${{ needs.integration-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          **Quality Gate:** ${{ needs.quality-gate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          
          ğŸ“‹ [View detailed results](${context.payload.pull_request.html_url}/checks)`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          }); 